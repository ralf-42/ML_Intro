<!-- MathJax Support für mathematische Formeln -->
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      ignoreHtmlClass: 'tex2jax_ignore',
      processHtmlClass: 'tex2jax_process'
    }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script" async></script>

<!-- Mermaid Diagramm Support -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'default',
    securityLevel: 'loose',
    flowchart: {
      htmlLabels: true,
      curve: 'basis'
    }
  });
</script>

<!-- Callout Transformation Script -->
<script src="{{ '/assets/js/callouts.js' | relative_url }}"></script>

<!-- Externe Links in neuem Tab öffnen -->
<script>
  (function() {
    'use strict';

    // Debug-Modus (auf false setzen für Produktion)
    const DEBUG = false;

    function log(message, data) {
      if (DEBUG) {
        console.log('[External Links]', message, data || '');
      }
    }

    // Prüft ob Link extern ist
    function isExternalLink(link) {
      // Prüfung 1: Hat überhaupt einen href?
      if (!link.href) return false;

      // Prüfung 2: Ist es ein http/https Link?
      if (!link.href.startsWith('http://') && !link.href.startsWith('https://')) {
        return false;
      }

      // Prüfung 3: Zeigt er auf eine andere Domain?
      // Wichtig: link.href (Property) nutzen, nicht getAttribute('href')
      // link.href gibt die vollständig aufgelöste URL zurück
      const isExternal = !link.href.includes(window.location.hostname);

      return isExternal;
    }

    // Setzt target="_blank" auf einem Link
    function makeExternalLink(link) {
      // Nur setzen wenn noch nicht gesetzt
      if (link.getAttribute('target') !== '_blank') {
        link.setAttribute('target', '_blank');
        link.setAttribute('rel', 'noopener noreferrer');
        log('Link marked as external:', link.href);
        return true;
      }
      return false;
    }

    // METHODE 1: DOM Processing beim Laden (Ihr Code + meine Verbesserungen)
    function processAllLinks() {
      const links = document.querySelectorAll('a[href^="http"]');
      let processed = 0;

      for (const link of links) {
        if (isExternalLink(link)) {
          if (makeExternalLink(link)) {
            processed++;
          }
        }
      }

      log('Processed links at DOM load:', processed);
    }

    // METHODE 2: Click Event Handler (Fallback)
    // Fängt Klicks ab und setzt target="_blank" dynamisch
    document.addEventListener('click', function(event) {
      const link = event.target.closest('a');

      if (link && isExternalLink(link)) {
        makeExternalLink(link);
        log('Link clicked:', link.href);
      }
    }, true);

    // METHODE 3: MutationObserver für dynamisch geladene Inhalte
    function observeDynamicContent() {
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          mutation.addedNodes.forEach(function(node) {
            if (node.nodeType === 1) { // Element node
              // Prüfe das Element selbst
              if (node.tagName === 'A' && isExternalLink(node)) {
                makeExternalLink(node);
              }
              // Prüfe alle Links innerhalb des Elements
              const links = node.querySelectorAll ? node.querySelectorAll('a[href^="http"]') : [];
              for (const link of links) {
                if (isExternalLink(link)) {
                  makeExternalLink(link);
                }
              }
            }
          });
        });
      });

      observer.observe(document.body, {
        childList: true,
        subtree: true
      });

      log('MutationObserver started');
    }

    // Initialisierung
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        processAllLinks();
        observeDynamicContent();
      });
    } else {
      // DOM bereits geladen
      processAllLinks();
      observeDynamicContent();
    }

    // Nochmal beim vollständigen Laden
    window.addEventListener('load', function() {
      processAllLinks();
    });

  })();
</script>
