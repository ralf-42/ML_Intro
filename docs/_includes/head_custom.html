<!-- MathJax Support für mathematische Formeln -->
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      ignoreHtmlClass: 'tex2jax_ignore',
      processHtmlClass: 'tex2jax_process'
    }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script" async></script>

<!-- Mermaid Diagramm Support -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
  mermaid.initialize({
    startOnLoad: true,
    theme: 'default',
    securityLevel: 'loose',
    flowchart: {
      htmlLabels: true,
      curve: 'basis'
    }
  });
</script>

<!-- Callout Transformation Script -->
<script src="{{ '/assets/js/callouts.js' | relative_url }}"></script>

<!-- Externe Links in neuem Tab öffnen -->
<script>
  // METHODE 1: Event Delegation auf document-Level
  // Fängt alle Klicks auf Links ab, bevor sie verarbeitet werden
  document.addEventListener('click', function(event) {
    // Prüfen ob ein Link geklickt wurde
    const link = event.target.closest('a[href]');

    if (link) {
      const href = link.getAttribute('href');

      // Externer Link wenn:
      // 1. Beginnt mit http:// oder https://
      // 2. Enthält nicht die eigene Domain
      if (href && (href.startsWith('http://') || href.startsWith('https://'))) {
        const currentHost = window.location.host;

        try {
          const linkUrl = new URL(href);

          // Wenn externe Domain
          if (linkUrl.host !== currentHost) {
            // Target auf _blank setzen wenn nicht bereits gesetzt
            if (!link.hasAttribute('target')) {
              link.setAttribute('target', '_blank');
              link.setAttribute('rel', 'noopener noreferrer');
            }
          }
        } catch (e) {
          // Bei Parsing-Fehler: Externer Link
          if (!href.includes(currentHost)) {
            link.setAttribute('target', '_blank');
            link.setAttribute('rel', 'noopener noreferrer');
          }
        }
      }
    }
  }, true); // useCapture = true, um Event vor anderen Handlern zu fangen

  // METHODE 2: Zusätzlich DOM-Processing beim Laden
  function processExternalLinks() {
    const links = document.querySelectorAll('a[href^="http://"], a[href^="https://"]');
    const currentHost = window.location.host;

    links.forEach(function(link) {
      const href = link.getAttribute('href');

      try {
        const linkUrl = new URL(href);

        if (linkUrl.host !== currentHost) {
          link.setAttribute('target', '_blank');
          link.setAttribute('rel', 'noopener noreferrer');
        }
      } catch (e) {
        if (!href.includes(currentHost)) {
          link.setAttribute('target', '_blank');
          link.setAttribute('rel', 'noopener noreferrer');
        }
      }
    });
  }

  // Bei verschiedenen Events ausführen
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', processExternalLinks);
  } else {
    processExternalLinks();
  }

  window.addEventListener('load', processExternalLinks);
</script>
